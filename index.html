<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatwoot Auto‐Open with Existing History</title>

  <style id="style">

    @media only screen and (min-width: 667px) {
      .woot-widget-holder {
        border-radius: 16px;
        /* bottom: 104px;
        height: calc(90% - 64px - 20px);
        max-height: 640px !important;
        min-height: 250px !important;
        width: 400px !important; */
        width: 100% !important;
        height: 100vh !important;
        min-height: 100vh !important;
        bottom: 0;
      }


      .woot-widget-holder.woot-elements--right {
        /* right: 20px; */
        right: 0px;
      }

      .woot--bubble-holder {
        display: none;
      }
    }
  </style>
</head>

<body>
  <script>
    // 1. Try to read values from query params
    function getChatwootIdFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get("uid");
    }

    function getChatwootTokenFromQuery() {
        const params = new URLSearchParams(window.location.search);
        return params.get("token");
      }

      function getIdentifierHashFromQuery() {
        const params = new URLSearchParams(window.location.search);
        return params.get("hash");
      }

      function getConversationIdFromQuery() {
        const params = new URLSearchParams(window.location.search);
        return params.get("cid");
      }

    // 2. Load environment defaults from .env if present
    function loadEnv() {
      return fetch('.env')
        .then((resp) => resp.ok ? resp.text() : '')
        .then((text) => {
          const env = {};
          text.split('\n').forEach((line) => {
            const trimmed = line.trim();
            if (!trimmed || trimmed.startsWith('#')) return;
            const [key, ...rest] = trimmed.split('=');
            env[key] = rest.join('=');
          });
          return env;
        })
        .catch(() => ({}));
    }

    // 3. Generate or reuse a UUID in localStorage so we get a stable contactId
    function getOrCreateChatwootId(preferredId) {
      let id = localStorage.getItem("chatwoot_contact_id");

      if (preferredId) {
        id = preferredId;
        localStorage.setItem("chatwoot_contact_id", id);
        return id;
      }

      if (!id) {
        if (crypto && typeof crypto.randomUUID === "function") {
          id = crypto.randomUUID();
        } else {
          id = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          });
        }
        localStorage.setItem("chatwoot_contact_id", id);
      }
      return id;
    }


    function getCookie(name) {
      const match = document.cookie
        .split('; ')
        .find((c) => c.startsWith(name + '='));
      return match ? match.split('=')[1] : null;
    }

    function setCookie(name, value) {
      document.cookie = name + '=' + value + '; path=/';
    }

    function getConversationCookieName(token) {
      const base = 'cw_conversation';
      const withToken = base + '_' + token;
      const cookies = document.cookie.split('; ');
      if (cookies.some((c) => c.startsWith(withToken + '='))) {
        return withToken;
      }
      return base;
    }

    function initChatwoot(env) {
      const CHATWOOT_BASE = env.CHATWOOT_BASE;
      const WEBSITE_TOKEN = getChatwootTokenFromQuery() || env.WEBSITE_TOKEN;
      const identifierHash = getIdentifierHashFromQuery() || env.IDENTIFIER_HASH;
      if (!CHATWOOT_BASE || !WEBSITE_TOKEN) {
        console.error('CHATWOOT_BASE or WEBSITE_TOKEN missing in .env');
        return;
      }
      // 4. First check query param, then fallback to .env
      const queryId = getChatwootIdFromQuery();
      const contactId = getOrCreateChatwootId(queryId);
      const convStoreKey = 'chatwoot_conversation_' + contactId;

      const queryCid = getConversationIdFromQuery();
      let convId = queryCid || localStorage.getItem(convStoreKey);
      if (convId) {
        const cookieName = getConversationCookieName(WEBSITE_TOKEN);
        setCookie(cookieName, convId);
        localStorage.setItem(convStoreKey, convId);
      }

      // If no uid was supplied in the query string, add the generated id to the URL
      if (!queryId) {
        const url = new URL(window.location);
        url.searchParams.set('uid', contactId);
        window.history.replaceState({}, '', url);
      }

      // 2. Inject the Chatwoot SDK script
      const script = document.createElement("script");
      script.src = CHATWOOT_BASE + "/packs/js/sdk.js";
      script.defer = true;

      script.onload = () => {
        // 3a. Initialize the widget (must come before setUser)
        window.chatwootSDK.run({
          websiteToken: WEBSITE_TOKEN,
          baseUrl: CHATWOOT_BASE
        });

        // 3b. Identify the visitor (writes cw_user_<id> & cw_conversation cookies under the hood)
        const userInfo = {
          name: "Alice Doe",
          email: "alice@example.com"
        };
        if (identifierHash) {
          userInfo.identifier_hash = identifierHash;
        }
        window.$chatwoot.setUser(contactId, userInfo);

      };

      document.head.appendChild(script);

      // 4. As soon as Chatwoot is fully ready, toggle the widget open
      window.addEventListener("chatwoot:ready", () => {
        // If a prior conversation exists for contactId, it'll load here.
        // If not, Chatwoot shows “Start a conversation” as usual.
        window.$chatwoot.toggle();
        const styleEl = document.getElementById('style');
        document.body.appendChild(styleEl.cloneNode(true));

        const cookieName = getConversationCookieName(WEBSITE_TOKEN);
        const cid = getCookie(cookieName);
        if (cid) {
          localStorage.setItem(convStoreKey, cid);
          const url = new URL(window.location);
          if (url.searchParams.get('cid') !== cid) {
            url.searchParams.set('cid', cid);
            window.history.replaceState({}, '', url);
          }
        }

      });
    }

    loadEnv().then(initChatwoot);
  </script>
</body>

</html>
