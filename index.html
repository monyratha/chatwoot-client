<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatwoot Auto‐Open with Existing History</title>

  <style id="style">

    @media only screen and (min-width: 667px) {
      .woot-widget-holder {
        border-radius: 16px;
        /* bottom: 104px;
        height: calc(90% - 64px - 20px);
        max-height: 640px !important;
        min-height: 250px !important;
        width: 400px !important; */
        width: 100% !important;
        height: 100vh !important;
        min-height: 100vh !important;
        bottom: 0;
      }


      .woot-widget-holder.woot-elements--right {
        /* right: 20px; */
        right: 0px;
      }

      .woot--bubble-holder {
        display: none;
      }
    }
  </style>
</head>

<body>
  <script>
    // 1. Try to read contactId from query params
    function getChatwootIdFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get("uid");
    }

    // 1. Generate or reuse a UUID in localStorage so we get a stable contactId
    function getOrCreateChatwootId() {
      let id = localStorage.getItem("chatwoot_contact_id");
      if (!id) {
        if (crypto && typeof crypto.randomUUID === "function") {
          id = crypto.randomUUID();
        } else {
          id = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          });
        }
        localStorage.setItem("chatwoot_contact_id", id);
      }
      return id;
    }


    (function () {
      const CHATWOOT_BASE = "http://192.168.80.16:3000/";
      const WEBSITE_TOKEN = "aj7CtUohDRR3w7ybAwvXzGbM";
      // 3. First check query param, then fallback
      const queryId = getChatwootIdFromQuery();
      const contactId = queryId || getOrCreateChatwootId();

      // 2. Inject the Chatwoot SDK script
      const script = document.createElement("script");
      script.src = CHATWOOT_BASE + "/packs/js/sdk.js";
      script.defer = true;

      script.onload = () => {
        // 3a. Initialize the widget (must come before setUser)
        window.chatwootSDK.run({
          websiteToken: WEBSITE_TOKEN,
          baseUrl: CHATWOOT_BASE
        });

        // 3b. Identify the visitor (writes cw_user_<id> & cw_conversation cookies under the hood)
        window.$chatwoot.setUser(contactId, {
          name: "Alice Doe",
          email: "alice@example.com"
        });

      };

      document.head.appendChild(script);

      // 4. As soon as Chatwoot is fully ready, toggle the widget open
      window.addEventListener("chatwoot:ready", () => {
        // If a prior conversation exists for contactId, it'll load here.
        // If not, Chatwoot shows “Start a conversation” as usual.
        window.$chatwoot.toggle();
        const styleEl = document.getElementById('style');
        document.body.appendChild(styleEl.cloneNode(true));

      });
    })();
  </script>
</body>

</html>
